name: Performance Benchmarks

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:
  schedule:
    # Run benchmarks weekly on Saturdays at 00:00 UTC
    - cron: '0 0 * * 6'

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install || npm install --legacy-peer-deps

    - name: Build extension (Development)
      run: npm run esbuild
      
    - name: Build extension (Production)
      run: npm run esbuild-base-minify

    - name: Measure build performance
      run: |
        echo "## âš¡ Build Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Development build
        START=$(date +%s%N)
        npm run esbuild > /dev/null 2>&1
        END=$(date +%s%N)
        DEV_TIME=$(( ($END - $START) / 1000000 ))
        
        # Production build
        START=$(date +%s%N)
        npm run esbuild-base-minify > /dev/null 2>&1
        END=$(date +%s%N)
        PROD_TIME=$(( ($END - $START) / 1000000 ))
        
        echo "- **Development Build:** ${DEV_TIME}ms" >> $GITHUB_STEP_SUMMARY
        echo "- **Production Build:** ${PROD_TIME}ms" >> $GITHUB_STEP_SUMMARY

    - name: Analyze bundle size
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "out/extension.js" ]; then
          SIZE=$(stat -c%s "out/extension.js" 2>/dev/null || stat -f%z "out/extension.js" 2>/dev/null)
          SIZE_KB=$((SIZE / 1024))
          SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
          
          echo "- **Raw Size:** ${SIZE} bytes" >> $GITHUB_STEP_SUMMARY
          echo "- **Size (KB):** ${SIZE_KB} KB" >> $GITHUB_STEP_SUMMARY
          echo "- **Size (MB):** ${SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          
          # Check if size is reasonable
          if [ $SIZE_KB -gt 5000 ]; then
            echo "::warning::Bundle size exceeds 5MB - consider optimization"
          fi
        fi

    - name: Count dependencies
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Dependency Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        DEPS=$(cat package.json | grep -A 100 '"dependencies"' | grep -c '": "' || echo "0")
        DEV_DEPS=$(cat package.json | grep -A 100 '"devDependencies"' | grep -c '": "' || echo "0")
        
        echo "- **Production Dependencies:** $DEPS" >> $GITHUB_STEP_SUMMARY
        echo "- **Development Dependencies:** $DEV_DEPS" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Dependencies:** $(($DEPS + $DEV_DEPS))" >> $GITHUB_STEP_SUMMARY

    - name: Analyze code complexity
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ§® Code Complexity" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        TS_FILES=$(find src -name "*.ts" | wc -l)
        TOTAL_LINES=$(find src -name "*.ts" -exec wc -l {} + | tail -1 | awk '{print $1}')
        AVG_LINES=$(($TOTAL_LINES / $TS_FILES))
        
        echo "- **TypeScript Files:** $TS_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Lines of Code:** $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
        echo "- **Average Lines per File:** $AVG_LINES" >> $GITHUB_STEP_SUMMARY

    - name: Memory usage analysis
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ’¾ Memory Profile" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Memory profiling requires runtime analysis in VS Code environment." >> $GITHUB_STEP_SUMMARY
        echo "Consider using VS Code Extension Host Profiler for detailed analysis." >> $GITHUB_STEP_SUMMARY
